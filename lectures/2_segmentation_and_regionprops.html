
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Segmentation &#8212; Bioimage analysis fundamentals in Python</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="out-of-core image analysis with dask" href="3_dask.html" />
    <link rel="prev" title="Image filtering" href="1_image_filters.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Bioimage analysis fundamentals in Python</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="0_i2k_bioimage_analysis_fundamentals.html">
   I2K 2020: Bioimage analysis fundamentals
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="1_image_filters.html">
   Image filtering
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3_dask.html">
   out-of-core image analysis with dask
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4_discussion.html">
   discussion
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/lectures/2_segmentation_and_regionprops.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/lectures/2_segmentation_and_regionprops.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#separating-an-image-into-one-or-more-regions-of-interest">
   Separating an image into one or more regions of interest.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#segmenting-nuclei-and-measuring-cell-properties">
   Segmenting nuclei and measuring cell properties
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#edge-detection">
   Edge detection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#thresholding">
   Thresholding
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#morphological-operations">
   Morphological operations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Segmentation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-measurements">
   Making measurements
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#challenge-problems">
   Challenge problems
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#improve-the-segmentation">
     Improve the segmentation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#segment-cell-membranes">
     Segment cell membranes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#measure-the-area-in-m3-of-the-cells">
     Measure the area in µm³ of the cells
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">gui</span> qt
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="segmentation">
<h1>Segmentation<a class="headerlink" href="#segmentation" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<div class="section" id="separating-an-image-into-one-or-more-regions-of-interest">
<h2>Separating an image into one or more regions of interest.<a class="headerlink" href="#separating-an-image-into-one-or-more-regions-of-interest" title="Permalink to this headline">¶</a></h2>
<p>Everyone has heard or seen Photoshop or a similar graphics editor take a person from one image and place them into another.  The first step of doing this is <em>identifying where that person is in the source image</em>.</p>
<p>In popular culture, the Terminator’s vision segments humans out of the overall scene:</p>
<img src="../images/terminator-vision.png" width="700px"/>
<p>Segmentation is a fundamental operation in scientific image analysis because we often want to measure properties of real, physical <em>objects</em> such as cells embedded in our image. As such, we want to find those objects within our image.</p>
<p>Computationally, segmentations are most often represented as images, of the same size as the original image, containing integer <em>labels</em>, with one value representing one object.</p>
<p>Here is a very simple image and segmentation, taken from <a class="reference external" href="https://scikit-image.org/docs/dev/auto_examples/segmentation/plot_watershed.html#sphx-glr-auto-examples-segmentation-plot-watershed-py">this scikit-image tutorial</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>

<span class="kn">import</span> <span class="nn">napari</span>

<span class="kn">from</span> <span class="nn">skimage.segmentation</span> <span class="kn">import</span> <span class="n">watershed</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">peak_local_max</span>


<span class="c1"># Generate an initial image with two overlapping circles</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">52</span>
<span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span>
<span class="n">mask_circle1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r1</span><span class="o">**</span><span class="mi">2</span>
<span class="n">mask_circle2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="o">**</span><span class="mi">2</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask_circle1</span><span class="p">,</span> <span class="n">mask_circle2</span><span class="p">)</span>

<span class="c1"># Now we want to separate the two objects in image</span>
<span class="c1"># Generate the markers as local maxima of the distance to the background</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">labels</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">markers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">watershed</span><span class="p">(</span><span class="o">-</span><span class="n">distance</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>

<span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
<span class="n">image_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">labels_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">labels_as_image_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;labels as image&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Notice that “labels” is just a NumPy array with integer values. We have to be careful to interpret it as labels and not as an image.</p>
</div>
<div class="section" id="segmenting-nuclei-and-measuring-cell-properties">
<h2>Segmenting nuclei and measuring cell properties<a class="headerlink" href="#segmenting-nuclei-and-measuring-cell-properties" title="Permalink to this headline">¶</a></h2>
<p>In the rest of this notebook, we will segment nuclei from a small sample image provided by the Allen Institute for Cell Science.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuclei</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;../images/cells.tif&#39;</span><span class="p">)</span>
<span class="n">membranes</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;../images/cells_membrane.tif&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nuclei</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dtype: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nuclei</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;range: (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nuclei</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nuclei</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>shape: (60, 256, 256)
dtype: float64
range: (0.0, 1.0)
</pre></div>
</div>
</div>
</div>
<p>The pixel spacing in this dataset is 0.29µm in the z (leading!) axis, and 0.26µm in the x and y axes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.29</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We can view the 3D image using napari.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">view_image</span><span class="p">(</span>
    <span class="n">nuclei</span><span class="p">,</span>
    <span class="n">contrast_limits</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">ndisplay</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">napari.utils.notebook_display</span> <span class="kn">import</span> <span class="n">nbscreenshot</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">ndisplay</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_13_0.png" src="../_images/2_segmentation_and_regionprops_13_0.png" />
</div>
</div>
</div>
<div class="section" id="edge-detection">
<h2>Edge detection<a class="headerlink" href="#edge-detection" title="Permalink to this headline">¶</a></h2>
<p>We saw the <a class="reference external" href="https://en.wikipedia.org/wiki/Sobel_operator">Sobel operator</a> in the filters lesson. It is an edge detection algorithm that approximates the gradient of the image intensity, and is fast to compute. The <a class="reference external" href="https://scikit-image.org/docs/dev/api/skimage.filters.html#skimage.filters.scharr">Scharr filter</a> is a slightly more sophisticated version, with smoothing weights [3, 10, 3]. Both work for n-dimensional images in scikit-image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">edges</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">scharr</span><span class="p">(</span><span class="n">nuclei</span><span class="p">)</span>

<span class="n">nuclei_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;nuclei&#39;</span><span class="p">]</span>
<span class="n">nuclei_layer</span><span class="o">.</span><span class="n">blending</span> <span class="o">=</span> <span class="s1">&#39;additive&#39;</span>
<span class="n">nuclei_layer</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">edges</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">blending</span><span class="o">=</span><span class="s1">&#39;additive&#39;</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Image layer &#39;edges&#39; at 0x7fa2b239f790&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_16_0.png" src="../_images/2_segmentation_and_regionprops_16_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">denoised</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">nuclei</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="thresholding">
<h2>Thresholding<a class="headerlink" href="#thresholding" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Thresholding_%28image_processing%29">Thresholding</a> is used to create binary images. A threshold value determines the intensity value separating foreground pixels from background pixels. Foregound pixels are pixels brighter than the threshold value, background pixels are darker. In many cases, images can be adequately segmented by thresholding followed by labelling of <em>connected components</em>, which is a fancy way of saying “groups of pixels that touch each other”.</p>
<p>Different thresholding algorithms produce different results. <a class="reference external" href="https://en.wikipedia.org/wiki/Otsu%27s_method">Otsu’s method</a> and <a class="reference external" href="https://scikit-image.org/docs/dev/auto_examples/developers/plot_threshold_li.html">Li’s minimum cross entropy threshold</a> are two common algorithms. Below, we use Li. You can use <code class="docutils literal notranslate"><span class="pre">skimage.filters.threshold_&lt;TAB&gt;</span></code> to find different thresholding methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">li_thresholded</span> <span class="o">=</span> <span class="n">denoised</span> <span class="o">&gt;</span> <span class="n">filters</span><span class="o">.</span><span class="n">threshold_li</span><span class="p">(</span><span class="n">denoised</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">li_thresholded</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Image layer &#39;li_thresholded&#39; at 0x7fa2b2e5f730&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_21_0.png" src="../_images/2_segmentation_and_regionprops_21_0.png" />
</div>
</div>
</div>
<div class="section" id="morphological-operations">
<h2>Morphological operations<a class="headerlink" href="#morphological-operations" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Mathematical_morphology">Mathematical morphology</a> operations and structuring elements are defined in <code class="docutils literal notranslate"><span class="pre">skimage.morphology</span></code>. Structuring elements are shapes which define areas over which an operation is applied. The response to the filter indicates how well the neighborhood corresponds to the structuring element’s shape.</p>
<p>There are a number of two and three dimensional structuring elements defined in <code class="docutils literal notranslate"><span class="pre">skimage.morphology</span></code>. Not all 2D structuring element have a 3D counterpart. The simplest and most commonly used structuring elements are the <code class="docutils literal notranslate"><span class="pre">disk</span></code>/<code class="docutils literal notranslate"><span class="pre">ball</span></code> and <code class="docutils literal notranslate"><span class="pre">square</span></code>/<code class="docutils literal notranslate"><span class="pre">cube</span></code>.</p>
<p>Functions operating on <a class="reference external" href="https://en.wikipedia.org/wiki/Connected_space">connected components</a> can remove small undesired elements while preserving larger shapes.</p>
<p><code class="docutils literal notranslate"><span class="pre">skimage.morphology.remove_small_holes</span></code> fills holes and <code class="docutils literal notranslate"><span class="pre">skimage.morphology.remove_small_objects</span></code> removes bright regions. Both functions accept a size parameter, which is the minimum size (in pixels) of accepted holes or objects. It’s useful in 3D to think in linear dimensions, then cube them. In this case, we remove holes / objects of the same size as a cube 20 pixels across.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">morphology</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">remove_holes</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_holes</span><span class="p">(</span>
    <span class="n">li_thresholded</span><span class="p">,</span> <span class="n">width</span> <span class="o">**</span> <span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">remove_objects</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
    <span class="n">remove_holes</span><span class="p">,</span> <span class="n">width</span> <span class="o">**</span> <span class="mi">3</span>
<span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">remove_objects</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cleaned&#39;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;li_thresholded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_28_0.png" src="../_images/2_segmentation_and_regionprops_28_0.png" />
</div>
</div>
</div>
<div class="section" id="id1">
<h2>Segmentation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Now we are ready to label the connected components of this image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">measure</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">remove_objects</span><span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;cleaned&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_32_0.png" src="../_images/2_segmentation_and_regionprops_32_0.png" />
</div>
</div>
<p>We can see that tightly packed cells connected in the binary image are assigned the same label.</p>
<p>A better segmentation would assign different labels to different nuclei.</p>
<p>Typically we use <a class="reference external" href="https://en.wikipedia.org/wiki/Watershed_%28image_processing%29">watershed segmentation</a> for this purpose. We place <em>markers</em> at the centre of each object, and these labels are expanded until they meet an edge or an adjacent marker.</p>
<p>The trick, then, is how to find these markers. It can be quite challenging to find markers with the right location. A slight amount of noise in the image can result in very wrong point locations. Here is a common approach: find the distance from the object boundaries, then place points at the maximal distance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transformed</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">remove_objects</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="n">spacing</span><span class="p">)</span>

<span class="n">maxima</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">local_maxima</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">maxima</span><span class="p">))</span> <span class="o">*</span> <span class="n">spacing</span><span class="p">,</span>  <span class="c1"># don&#39;t forget scale</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bad points&#39;</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Points layer &#39;bad points&#39; at 0x7fa2b2310490&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_36_0.png" src="../_images/2_segmentation_and_regionprops_36_0.png" />
</div>
</div>
<p>You can see that these points are actually terrible, with many markers found within each nuclei.</p>
<p>There are many approaches to find better points, but with napari, in many cases, a little interactivity can quickly get us the segmentation we want.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;bad points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">ndisplay</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">set_point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interactive points&#39;</span><span class="p">,</span>
    <span class="n">ndim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">points</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;add&#39;</span>


<span class="c1"># now, we annotate the centers of the nuclei in your image</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_39_0.png" src="../_images/2_segmentation_and_regionprops_39_0.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># scaled points.data</span>

<span class="n">points</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
      <span class="p">[[</span> <span class="mf">8.7</span>       <span class="p">,</span>  <span class="mf">3.10175426</span><span class="p">,</span>  <span class="mf">7.22127134</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span>  <span class="mf">8.31173204</span><span class="p">,</span> <span class="mf">21.63958194</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span>  <span class="mf">2.85942971</span><span class="p">,</span> <span class="mf">38.48113801</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">11.34078889</span><span class="p">,</span> <span class="mf">46.23552354</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">12.06776253</span><span class="p">,</span> <span class="mf">58.83640003</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">18.97401214</span><span class="p">,</span> <span class="mf">29.39396747</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">25.03212584</span><span class="p">,</span> <span class="mf">42.11600623</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">25.03212584</span><span class="p">,</span> <span class="mf">64.89451373</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">36.30021731</span><span class="p">,</span> <span class="mf">62.10778143</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">36.17905504</span><span class="p">,</span> <span class="mf">48.90109357</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">41.63135737</span><span class="p">,</span> <span class="mf">27.09188426</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">22.85120491</span><span class="p">,</span> <span class="mf">13.52170958</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">35.57324367</span><span class="p">,</span> <span class="mf">11.21962638</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">49.99155427</span><span class="p">,</span> <span class="mf">12.79473594</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">57.38245298</span><span class="p">,</span> <span class="mf">20.06447238</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">61.98661939</span><span class="p">,</span> <span class="mf">36.78486618</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">53.98990931</span><span class="p">,</span> <span class="mf">45.62971217</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">64.65218941</span><span class="p">,</span> <span class="mf">53.02061088</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.7</span>       <span class="p">,</span> <span class="mf">57.50361525</span><span class="p">,</span> <span class="mf">63.44056644</span><span class="p">]],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell tag_remove-input tag_remove-output docutils container">
</div>
<p>Once you have marked all the points, you can grab the data back, and make a markers image for <code class="docutils literal notranslate"><span class="pre">skimage.segmentation.watershed</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">segmentation</span>

<span class="n">marker_locations</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">spacing</span>

<span class="n">markers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nuclei</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<span class="n">marker_indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">marker_locations</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">markers</span><span class="p">[</span><span class="n">marker_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">marker_locations</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">markers_big</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span> <span class="n">morphology</span><span class="o">.</span><span class="n">ball</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="n">segmented</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">watershed</span><span class="p">(</span>
    <span class="n">edges</span><span class="p">,</span>
    <span class="n">markers_big</span><span class="p">,</span>
    <span class="n">mask</span><span class="o">=</span><span class="n">remove_objects</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span>
    <span class="n">segmented</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_44_0.png" src="../_images/2_segmentation_and_regionprops_44_0.png" />
</div>
</div>
<p>After watershed, we have better disambiguation between internal cells!</p>
</div>
<div class="section" id="making-measurements">
<h2>Making measurements<a class="headerlink" href="#making-measurements" title="Permalink to this headline">¶</a></h2>
<p>Once we have defined our objects, we can make measurements on them using <code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops</span></code> and the new <code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops_table</span></code>. These measurements include features such as area or volume, bounding boxes, and intensity statistics.</p>
<p>Before measuring objects, it helps to clear objects from the image border. Measurements should only be collected for objects entirely contained in the image.</p>
<p>Given the layer-like structure of our data, we only want to clear the objects touching the sides of the volume, but not the top and bottom, so we pad and crop the volume along the 0th axis to avoid clearing the mitotic nucleus.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">segmented_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
    <span class="n">segmented</span><span class="p">,</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
    <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interior_labels</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">clear_border</span><span class="p">(</span><span class="n">segmented_padded</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops</span></code> automatically measures many labeled image features. Optionally, an <code class="docutils literal notranslate"><span class="pre">intensity_image</span></code> can be supplied and intensity features are extracted per object. It’s good practice to make measurements on the original image.</p>
<p>Not all properties are supported for 3D data. Below are lists of supported and unsupported 3D measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regionprops</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">interior_labels</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">nuclei</span><span class="p">)</span>

<span class="n">supported</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="n">unsupported</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">regionprops</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">regionprops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>
        <span class="n">supported</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="n">unsupported</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Supported properties:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">supported</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unsupported properties:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unsupported</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Supported properties:
  area
  bbox
  bbox_area
  centroid
  convex_area
  convex_image
  coords
  equivalent_diameter
  euler_number
  extent
  filled_area
  filled_image
  image
  inertia_tensor
  inertia_tensor_eigvals
  intensity_image
  label
  local_centroid
  major_axis_length
  max_intensity
  mean_intensity
  min_intensity
  minor_axis_length
  moments
  moments_central
  moments_normalized
  slice
  solidity
  weighted_centroid
  weighted_local_centroid
  weighted_moments
  weighted_moments_central
  weighted_moments_normalized

Unsupported properties:
  eccentricity
  moments_hu
  orientation
  perimeter
  weighted_moments_hu
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops</span></code> ignores the 0 label, which represents the background.</p>
<p><code class="docutils literal notranslate"><span class="pre">regionprops_table</span></code> returns a dictionary of columns compatible with creating a pandas dataframe of properties of the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="n">info_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span>
        <span class="n">interior_labels</span><span class="p">,</span>
        <span class="n">intensity_image</span><span class="o">=</span><span class="n">nuclei</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;solidity&#39;</span><span class="p">],</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>slice</th>
      <th>area</th>
      <th>mean_intensity</th>
      <th>solidity</th>
    </tr>
    <tr>
      <th>label</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>(slice(20, 53, None), slice(13, 55, None), sli...</td>
      <td>37410</td>
      <td>0.189264</td>
      <td>0.930666</td>
    </tr>
    <tr>
      <th>4</th>
      <td>(slice(19, 55, None), slice(26, 71, None), sli...</td>
      <td>36054</td>
      <td>0.211766</td>
      <td>0.922923</td>
    </tr>
    <tr>
      <th>5</th>
      <td>(slice(20, 52, None), slice(23, 75, None), sli...</td>
      <td>36993</td>
      <td>0.181161</td>
      <td>0.913002</td>
    </tr>
    <tr>
      <th>6</th>
      <td>(slice(19, 51, None), slice(47, 99, None), sli...</td>
      <td>40504</td>
      <td>0.185613</td>
      <td>0.911985</td>
    </tr>
    <tr>
      <th>7</th>
      <td>(slice(19, 54, None), slice(72, 121, None), sl...</td>
      <td>40130</td>
      <td>0.211141</td>
      <td>0.894242</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can now use pandas and seaborn for some analysis!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;solidity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">info_table</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;mean_intensity&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2_segmentation_and_regionprops_57_0.png" src="../_images/2_segmentation_and_regionprops_57_0.png" />
</div>
</div>
<p>We can see that the mitotic nucleus is a clear outlier from the others in terms of solidity and intensity.</p>
</div>
<div class="section" id="challenge-problems">
<h2>Challenge problems<a class="headerlink" href="#challenge-problems" title="Permalink to this headline">¶</a></h2>
<p>Put your 3D image processing skills to the test by working through these challenge problems.</p>
<div class="section" id="improve-the-segmentation">
<h3>Improve the segmentation<a class="headerlink" href="#improve-the-segmentation" title="Permalink to this headline">¶</a></h3>
<p>A few objects were oversegmented in the declumping step. Try to improve the segmentation and assign each object a single, unique label. You can try to use <a class="reference external" href="https://scikit-image.org/docs/dev/auto_examples/filters/plot_j_invariant.html">calibrated denoising</a> to get smoother nuclei and membrane images.</p>
</div>
<div class="section" id="segment-cell-membranes">
<h3>Segment cell membranes<a class="headerlink" href="#segment-cell-membranes" title="Permalink to this headline">¶</a></h3>
<p>Try segmenting the accompanying membrane channel. In the membrane image, the membrane walls are the bright web-like regions. This channel is difficult due to a high amount of noise in the image. Additionally, it can be hard to determine where the membrane ends in the image (it’s not the first and last planes).</p>
<p>Below is a 2D segmentation of the membrane:</p>
<p><img alt="" src="lectures/../_images/membrane_segmentation.png" /></p>
<p>Hint: there should only be one nucleus per membrane.</p>
</div>
<div class="section" id="measure-the-area-in-m3-of-the-cells">
<h3>Measure the area in µm³ of the cells<a class="headerlink" href="#measure-the-area-in-m3-of-the-cells" title="Permalink to this headline">¶</a></h3>
<p>Once you have segmented the cell membranes, use regionprops to measure the distribution of cell areas.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="1_image_filters.html" title="previous page">Image filtering</a>
    <a class='right-next' id="next-link" href="3_dask.html" title="next page">out-of-core image analysis with dask</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Juan Nunez-Iglesias & Nicholas Sofroniew, including work from the scikit-image and napari contributors.<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>